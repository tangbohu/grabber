#!/usr/bin/python
# -*- coding: utf-8 -*- 
"""dong fang cai fu wang"""
import  fetchWeb 
from web import Web
from BeautifulSoup import BeautifulSoup
import urllib2
import sys
import chardet
import time
import datetime
from info import Info




class ths(Web):
    def __init__(self,dic):
         Web.__init__(self,dic)
         self.url='http://stock.10jqka.com.cn/jiepan_list/index.shtml'
         self.soup=None
         self.fromweb="同花顺实时解盘"
         print 'tonghuashun init ok'
             
    def readWeb(self,url):
       html=urllib2.urlopen(url).read()
       localcode= sys.getfilesystemencoding()      # local encode format  
       
       #print html
       return BeautifulSoup(html.decode('gb2312','ignore').encode(localcode))

    def getChildSoup(self,link):
      #  print '--------------------------------------------------------','\n'
        childSoup=self.readWeb(link)
        #print childSoup
       # print '--------------------------------------------------------','\n'
        return childSoup  
  
    def searchTag(self,strinfo):

          result=[]
          for key in self.searchdict:
             print 'searching ',key
             if(strinfo.find(key)!=-1):
                print 'find ',key
	        result.append(key)
	     else:
                 pass
         # print result
	  return  result



    def linkAnalysis(self,link):
        temp=link.find("a")
        address=temp["href"]   
        brief=temp["title"]   
        print 'link address is : ',address 
        print 'link content is :', brief 
        
        timenow=link.find(attrs={"class":"date"}).string
        print timenow
        y=timenow[0:4]
        m=timenow[5:7]
        d=timenow[8:10]
        second=timenow[12:20]
        timenow=y+'-'+m+'-'+d+' '+second
        print timenow

        now= time.strptime(timenow, '%Y-%m-%d %H:%M:%S')
        print 'news time:',now
        print 'update time :',self.updateTime
        if time.mktime(now)<time.mktime(self.updateTime):
            print 'has no latest news'
            return 0
        else :
            print 'find latest news'
       
        childSoup=self.getChildSoup(address)      
        newsContent=childSoup.find(attrs={"class":"art_main"})
       # print newsContent

        stringTemp=""
        if not newsContent:
            return 1
        for content in newsContent:
            stringTemp+=str(content)
#        print stringTemp
#        print searchdict
        tags=self.searchTag(stringTemp)
       # print 'tags is ',tags
        if tags:
               newin=Info()
               newin.addLink(address,brief)
               for tag  in tags:
                  newin.addTag(tag)
                  print newin
                  print 'in this news find ',tag
               self.addInfo(newin)
               print 'useful info'
        else:
               print 'useless info'
        print '------------------------- one link analysis end ','------------------'
        return 1
        

    def collectInfo(self):
        self.clearInfo()
        self.soup=self.readWeb(self.url)
        #print self.soup
        temptime=time.localtime()
        print 'starting learning from ',self.url
        linkVector=self.soup.findAll(attrs={"class":"list_item"})
        print linkVector[0]
        for link in linkVector:
            if not self.linkAnalysis(link):
                 break
   #     self.linkAnalysis(linkVector[0])          

        self.updateTime=temptime
        print 'update done'
    

        

if __name__=='__main__':
    search=['上港集团']
    a=ths(search)
    a.collectInfo()
    
    
